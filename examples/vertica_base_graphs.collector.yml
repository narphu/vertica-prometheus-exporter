collector_name: vertica_base_graphs
metrics:
  - metric_name: vertica_connections_per_node
    type: counter
    help: 'Connections per node'
    key_labels:
       - node_name
    values: [totaltrans]
    query: |
        SELECT /*+ LABEL(exporter_vertica_global_status_connections_per_node) */ node_name , count(*) totaltrans 
        FROM v_monitor.sessions s 
        GROUP BY node_name
        ORDER BY node_name;
  - metric_name: vertica_query_requests_transactions_count_per_node
    type: counter
    help: 'Running transactions per node'
    key_labels:
       - node_name
    values: [total]
    query: |
       SELECT /*+ LABEL(exporter_vertica_query_requests_transactions_count_per_node) */
       node_name , count(*) total
       FROM transactions
       WHERE start_timestamp between date_trunc('minute',sysdate) - '1 minutes'::interval and date_trunc('minute',sysdate) - '1 milliseconds'::interval
       GROUP BY node_name;
  - metric_name: vertica_cpu_usage_pct
    type: counter
    help: 'vertica cpu usage percentage'
    key_labels: 
       - node_name
    values: [avg_cpu_usage_pct]
    query_ref: vertica_system_resources
  - metric_name: vertica_mem_usage_pct
    type: counter
    help: 'vertica memory usage percentage'
    key_labels:
       - node_name
    values: [avg_mem_usage_pct]
    query_ref: vertica_system_resources
  - metric_name: vertica_net_rx_kbytespersec
    type: counter
    help: 'Vertica Network Receive kbps'
    key_labels:
       - node_name
    values: [net_rx_kbps]
    query_ref: vertica_system_resources
  - metric_name: vertica_net_tx_kbytespersec
    type: counter
    help: 'Vertica Network Transmit kbps'
    key_labels:
       - node_name
    values: [net_tx_kbps]
    query_ref: vertica_system_resources
  - metric_name: vertica_io_read_kbytespersec
    type: counter
    help: 'Vertica IO Read kbps'
    key_labels:
       - node_name
    values: [io_read_kbps]
    query_ref: vertica_system_resources
  - metric_name: vertica_io_write_kbytespersec
    type: counter
    help: 'Vertica IO Writes kbps'
    key_labels:
       - node_name
    values: [io_write_kbps]
    query_ref: vertica_system_resources

queries:
  - query_name: vertica_system_resources
    query: |
       select  
          node_name,
          max(average_cpu_usage_percent) as avg_cpu_usage_pct,
          max(average_memory_usage_percent) as avg_mem_usage_pct,
          max(net_rx_kbytes_per_second) as net_rx_kbps,
          max(net_tx_kbytes_per_second) as net_tx_kbps,
          max(io_read_kbytes_per_second) as io_read_kbps,
          max(io_written_kbytes_per_second) as io_write_kbps
       from system_resource_usage 
       group by node_name;
       

